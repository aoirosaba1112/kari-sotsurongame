<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コイントスゲーム ver2.0</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>

<style>
:root{
  --bg:#ffffff;
  --panel:#f6f7fb;
  --primary:#0b84ff;
  --accent:#00a86b;
  --danger:#e03b3b;
  --muted:#666;
}
body{margin:0;font-family:"Meiryo",sans-serif;background:var(--bg);}
header,footer{text-align:center;padding:10px;color:var(--muted);}
#app{display:flex;flex-direction:column;align-items:center;min-height:100vh;}
.screen{display:none;flex-direction:column;align-items:center;width:100%;max-width:520px;padding:12px;box-sizing:border-box;}
.active{display:flex;}
.card{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.05);margin-bottom:12px;width:100%;}
.big-btn{padding:14px;border-radius:12px;border:0;font-size:20px;color:#fff;width:45%;}
.btn-primary{background:var(--primary);}
.btn-accent{background:var(--accent);}
.btn-danger{background:var(--danger);}
.btn-end{background:#555;}
.btn-row{display:flex;gap:10px;justify-content:center;margin-top:10px;}
#timer.red{color:red;font-weight:bold;}
</style>
</head>

<body>
<div id="app">
<header><h2>コイントスゲーム ver2.0</h2></header>

<!-- タイトル -->
<div id="title" class="screen active">
  <div class="card" style="text-align:center;">
    <h3>コイントスゲーム</h3>
    <p>制限時間：1分</p>
    <button id="start" class="big-btn btn-primary">スタート</button>
  </div>
</div>

<!-- ゲーム画面 -->
<div id="game" class="screen">
  <div class="card" style="text-align:center;">
    <div id="p5target" style="width:100%;aspect-ratio:3/2;"></div>
  </div>

  <div class="card">
    <div>
      所持ポイント：<span id="money">0</span>pt
      <span id="plusPoint" style="color:red;margin-left:5px;"></span>
    </div>
    <div>回数：<span id="count">0</span>回</div>
    <div>残り時間：<span id="timer">1分0秒</span></div>

    <!-- 獲得ポイント確率 -->
    <div id="probBox" style="margin-top:8px;color:#333;font-size:14px;line-height:1.4;">
      <div style="font-weight:bold;">勝ったときの獲得ポイント確率</div>
      <div id="probText"></div>
    </div>

    <div id="message" style="margin-top:8px;color:#333;">
      表か裏を選んでください！
    </div>

    <div class="btn-row">
      <button id="heads" class="big-btn btn-accent">表</button>
      <button id="tails" class="big-btn btn-danger">裏</button>
    </div>

    <div class="btn-row">
      <button id="end" class="big-btn btn-end" style="width:95%;">終了</button>
    </div>
  </div>
</div>

<!-- 終了確認 -->
<div id="confirm-exit" class="screen" style="
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);justify-content:center;align-items:center;display:none;">
  <div class="card" style="max-width:300px;text-align:center;">
    <p>本当に終了しますか？</p>
    <div class="btn-row">
      <button id="confirm-yes" class="big-btn btn-danger" style="width:45%;">はい</button>
      <button id="confirm-no" class="big-btn btn-accent" style="width:45%;">いいえ</button>
    </div>
  </div>
</div>

<!-- リザルト -->
<div id="result" class="screen">
  <div class="card" style="text-align:center;">
    <h3>リザルト</h3>
    <p id="timeup-msg" style="color:red;display:none;">時間切れです</p>
    <p>プレイ回数：<span id="result-count"></span>回</p>
    <p>当たり回数：<span id="result-win"></span>回</p>
    <p>はずれ回数：<span id="result-lose"></span>回</p>
    <p>最終ポイント：<span id="result-money"></span>pt</p>
    <p>勝率：<span id="result-rate"></span>%</p>

    <button id="goForm" class="big-btn btn-primary" style="width:95%;margin-top:10px;">
      アンケート回答に進む
    </button>
  </div>
</div>

<footer>© 2025 コイントスゲーム</footer>
</div>

<!-- SE -->
<audio id="warnSound" src="警告音1.mp3"></audio>
<audio id="seClick" src="決定ボタンを押す2.mp3"></audio>

<!-- ★ 追加：ポイント別 当たりSE -->
<audio id="seWin1"  src="決定ボタンを押す22.mp3"></audio>
<audio id="seWin3"  src="カーソル移動11.mp3"></audio>
<audio id="seWin10" src="歓声と拍手.mp3"></audio>

<audio id="seLose"  src="ビープ音4.mp3"></audio>
<audio id="seEnd"   src="決定ボタンを押す2.mp3"></audio>

<script>
/* ===== 状態 ===== */
let points=0,count=0,winCount=0,loseCount=0;
let animating=false,animProgress=0;
let face='表',coinResult=null,choice=null;
let timeLeft=60,timerId=null,warned=false; // 1分

/* ===== DOM ===== */
const title=document.getElementById('title');
const game=document.getElementById('game');
const result=document.getElementById('result');
const startBtn=document.getElementById('start');
const heads=document.getElementById('heads');
const tails=document.getElementById('tails');
const endBtn=document.getElementById('end');
const moneyLabel=document.getElementById('money');
const countLabel=document.getElementById('count');
const timerLabel=document.getElementById('timer');
const messageLabel=document.getElementById('message');
const warnSound=document.getElementById('warnSound');
const confirmExit=document.getElementById('confirm-exit');
const confirmYes=document.getElementById('confirm-yes');
const confirmNo=document.getElementById('confirm-no');
const goForm=document.getElementById('goForm');
const probText=document.getElementById('probText');

/* ===== SE ===== */
const seClick = document.getElementById('seClick');
const seWin1  = document.getElementById('seWin1');
const seWin3  = document.getElementById('seWin3');
const seWin10 = document.getElementById('seWin10');
const seLose  = document.getElementById('seLose');
const seEnd   = document.getElementById('seEnd');

const SE_VOLUME = 0.6;
let audioUnlocked=false;

function show(name){
  [title,game,result].forEach(s=>s.classList.remove('active'));
  document.getElementById(name).classList.add('active');
}

function playSE(a){
  try{
    if(!a) return;
    a.volume = SE_VOLUME;
    a.currentTime = 0;
    a.play();
  }catch(e){}
}

function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked=true;
  [warnSound,seClick,seWin1,seWin3,seWin10,seLose,seEnd].forEach(a=>{
    if(!a) return;
    try{
      a.volume = SE_VOLUME;
      a.play().then(()=>{
        a.pause();
        a.currentTime=0;
      }).catch(()=>{});
    }catch(e){}
  });
}

/* ===== イベント ===== */
startBtn.onclick=()=>{
  unlockAudioOnce();
  playSE(seClick);
  show('game');
  startTimer();
};
heads.onclick=()=>{
  unlockAudioOnce();
  playSE(seClick);
  flip('表');
};
tails.onclick=()=>{
  unlockAudioOnce();
  playSE(seClick);
  flip('裏');
};

endBtn.onclick=()=>{
  unlockAudioOnce();
  playSE(seClick);
  confirmExit.style.display='flex';
};
confirmYes.onclick=()=>{
  unlockAudioOnce();
  playSE(seEnd);
  confirmExit.style.display='none';
  endGame();
};
confirmNo.onclick=()=>{
  unlockAudioOnce();
  playSE(seClick);
  confirmExit.style.display='none';
};

function formatTime(sec){
  if(sec>=60){
    const m=Math.floor(sec/60),s=sec%60;
    return `${m}分${s}秒`;
  }
  return `${sec}秒`;
}

function startTimer(){
  timeLeft=60;warned=false;
  timerLabel.textContent=formatTime(timeLeft);
  timerLabel.classList.remove('red');
  timerId=setInterval(()=>{
    timeLeft--;
    timerLabel.textContent=formatTime(timeLeft);

    // 警告音：残り10秒
    if(timeLeft===10 && !warned){
      timerLabel.classList.add('red');
      playSE(warnSound);
      warned=true;
    }
    if(timeLeft<=0){
      clearInterval(timerId);
      endGame(true);
    }
  },1000);
}

function showPlusPoint(v){
  const pp=document.getElementById('plusPoint');
  pp.textContent=`+${v}pt`;
  setTimeout(()=>pp.textContent='',1000);
}

function flip(sel){
  if(animating)return;
  choice=sel;
  coinResult=Math.random()<0.5?'表':'裏';
  animating=true;
  animProgress=0;
  messageLabel.textContent='コインを投げています...';
  messageLabel.style.color='#333';
}

function updateUI(){
  moneyLabel.textContent=points;
  countLabel.textContent=count;
}

function endGame(timeup=false){
  clearInterval(timerId);
  show('result');
  if(timeup)document.getElementById('timeup-msg').style.display='block';
  const rate=count===0?0:Math.round(winCount/count*100);
  document.getElementById('result-count').textContent=count;
  document.getElementById('result-win').textContent=winCount;
  document.getElementById('result-lose').textContent=loseCount;
  document.getElementById('result-money').textContent=points;
  document.getElementById('result-rate').textContent=rate;
}

goForm.onclick=()=>{
  unlockAudioOnce();
  playSE(seClick);
  const formURL='https://docs.google.com/forms/d/e/1FAIpQLSe6apaA8qGkK-vIQdOevQ758g8_8MWfu2vkKeTk4dEaAyPgPA/viewform';
  const p=new URLSearchParams();
  p.append('entry.777971965',count);
  p.append('entry.504542349',winCount);
  p.append('entry.421740927',loseCount);
  p.append('entry.343215181',points);
  p.append('entry.1846564074',Math.round(winCount/count*100||0));
  location.href=formURL+'?'+p.toString();
};

/* ===== 獲得ポイント確率 ===== */
function renderProbabilities(){
  probText.textContent = '10pt：1% / 1pt：79.5% / 3pt：19.5%';
}
renderProbabilities();

/* ===== p5.js ===== */
new p5(s=>{
  s.setup=()=>{
    s.createCanvas(s.windowWidth*0.8,200).parent('p5target');
    s.textAlign(s.CENTER,s.CENTER);
    s.textStyle(s.BOLD);
  };
  s.windowResized=()=>s.resizeCanvas(s.windowWidth*0.8,200);

  s.draw=()=>{
    s.clear();
    if(animating){
      animProgress++;
      const angle=(animProgress*10)%360;
      const scaleX=Math.abs(Math.cos(angle*Math.PI/180));
      if(scaleX<0.05) face = face==='表' ? '裏' : '表';
      drawFace(face,angle);

      if(animProgress>60){
        face = coinResult;
        animating=false;

        const isWin = (choice === coinResult);
        if(isWin){
          winCount++;

          const r=Math.random()*100;
          const reward=r<1?10:r<80.5?1:3;
          points+=reward;

          showPlusPoint(reward);
          messageLabel.textContent=`結果:${coinResult}！当たり +${reward}pt`;
          messageLabel.style.color='red';

          // ★ ここがポイント別SE
          if(reward===1) playSE(seWin1);
          else if(reward===3) playSE(seWin3);
          else playSE(seWin10); // 10pt
        }else{
          loseCount++;
          messageLabel.textContent=`結果:${coinResult}！はずれ`;
          messageLabel.style.color='blue';
          playSE(seLose);
        }

        count++;
        updateUI();
      }
    }else{
      drawFace(face,0);
    }
  };

  function drawFace(f,a){
    const sx=Math.abs(Math.cos(a*Math.PI/180));
    s.push();
    s.translate(s.width/2,s.height/2);
    s.scale(sx,1);
    if(f==='表') s.fill('#00a86b');
    else s.fill('#e03b3b');
    s.textSize(80);
    s.text(f,0,0);
    s.pop();
  }
});
</script>
</body>
</html>
